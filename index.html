<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PadhaiSetu AI</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <script type="importmap">
    {
        "imports": {
            "react": "https://esm.sh/react@18.2.0",
            "react-dom/client": "https://esm.sh/react-dom@18.2.0/client",
            "lucide-react": "https://esm.sh/lucide-react@0.292.0?deps=react@18.2.0",
            "firebase/app": "https://www.gstatic.com/firebasejs/10.8.1/firebase-app.js",
            "firebase/auth": "https://www.gstatic.com/firebasejs/10.8.1/firebase-auth.js",
            "firebase/firestore": "https://www.gstatic.com/firebasejs/10.8.1/firebase-firestore.js"
        }
    }
    </script>

    <style>
        .scrollbar-hide::-webkit-scrollbar { display: none; }
        .scrollbar-hide { -ms-overflow-style: none; scrollbar-width: none; }
        @keyframes float { 0%, 100% { transform: translateY(0); } 50% { transform: translateY(-10px); } }
        .animate-float { animation: float 3s ease-in-out infinite; }
    </style>
</head>
<body class="bg-gray-50">
    <div id="error-display" style="display:none; padding:20px; color:red; background:white; font-family:monospace; margin:20px; border:2px solid red;"></div>
    
    <div id="root"></div>

    <script>
        window.onerror = function(msg, url, line) {
            document.getElementById('error-display').style.display = 'block';
            document.getElementById('error-display').innerHTML = "<h3>‚ö†Ô∏è App Crash Error:</h3>" + msg + "<br><small>Line: " + line + "</small><br><p>Please check index.html code on GitHub.</p>";
        };
    </script>

    <script type="text/babel" data-type="module">
        import React, { useState, useEffect, useRef } from 'react';
        import { createRoot } from 'react-dom/client';
        import { initializeApp } from 'firebase/app';
        import { getAuth, signInWithPopup, GoogleAuthProvider, onAuthStateChanged, signOut, signInAnonymously } from 'firebase/auth';
        import { getFirestore, doc, setDoc, getDoc, serverTimestamp, updateDoc, increment, collection, query, orderBy, onSnapshot, deleteDoc, addDoc } from 'firebase/firestore';
        import { MessageSquare, Mic, Image as ImageIcon, Send, Menu, X, LogOut, Crown, FileText, Play, BookOpen, Upload, CheckCircle, Sparkles, Headphones, Volume2, StopCircle, Loader2, Globe, IndianRupee, TrendingUp, Award, FileType, Download, Printer, Shield, GraduationCap, VolumeX, Activity, User, Heart, Smile, ChevronDown, Zap, Music, Plus, Trash2, MessageCircle, AlertCircle, ScanLine, FileCheck, ArrowLeft, Camera, Paperclip, ArrowDown, Maximize2, FileQuestion, Film, Languages, Box, Brain, MonitorPlay, Aperture, Pause, RotateCcw, Clapperboard, School, Lightbulb, Cpu, Copy, Check, Table as TableIcon, History } from 'lucide-react';

        // --- CONFIGURATION ---
        const FIREBASE_CONFIG = {
          apiKey: "AIzaSyCxj9wQwwhkgWlJhKUjOsxLQIRvil-C5ns",
          authDomain: "padhaisetu-ced2a.firebaseapp.com",
          databaseURL: "https://padhaisetu-ced2a-default-rtdb.firebaseio.com",
          projectId: "padhaisetu-ced2a",
          storageBucket: "padhaisetu-ced2a.firebasestorage.app",
          messagingSenderId: "635163904849",
          appId: "1:635163904849:web:6b9715b832cb34330a6170"
        };
        
        // üîó LINK TO VERCEL BACKEND
        const BACKEND_URL = "/api/gemini";

        // Initialize Firebase
        const app = initializeApp(FIREBASE_CONFIG);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const googleProvider = new GoogleAuthProvider();
        const appId = 'padhaisetu-ced2a';

        // --- UTILS ---
        const AI_VOICES = [
          { name: "Badi Didi (Caring)", id: "Aoede", icon: Heart }, 
          { name: "Bada Bhai (Cool)", id: "Fenrir", icon: User },   
          { name: "Dost (Fun)", id: "Iapetus", icon: Smile },          
          { name: "Sir (Serious)", id: "Orus", icon: BookOpen }   
        ];

        async function callBackendAI(payload) {
            try {
                const response = await fetch(BACKEND_URL, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });
                const data = await response.json();
                return data;
            } catch (error) {
                console.error("AI Error:", error);
                throw error;
            }
        }

        function cleanTextForTTS(text) {
            if (!text) return "";
            return text.replace(/[*#`|]/g, '').replace(/\[.*?\]/g, '').replace(/\n/g, '. ').trim();
        }

        // --- COMPONENTS ---
        function PadhaiSetuLogo() {
            return (
                <div className="flex items-center justify-center w-8 h-8 bg-cyan-600 rounded-lg text-white font-bold">
                    <GraduationCap size={20} />
                </div>
            );
        }

        function LoginScreen({ onLogin, onAnonLogin }) {
          return (
              <div className="min-h-screen bg-slate-900 flex flex-col items-center justify-center text-center p-4">
                <div className="w-24 h-24 bg-cyan-500/20 rounded-full flex items-center justify-center mb-6 animate-pulse">
                    <GraduationCap className="w-12 h-12 text-cyan-400" />
                </div>
                <h1 className="text-4xl font-bold text-white mb-2">PadhaiSetu AI</h1>
                <p className="text-gray-400 mb-8">Aapka Personal AI Teacher</p>
                <button onClick={onLogin} className="w-full max-w-sm bg-white text-black py-3 rounded-xl font-bold mb-3 flex items-center justify-center gap-2">
                    Start with Google
                </button>
                <button onClick={onAnonLogin} className="text-gray-500 text-sm hover:text-white">Skip Login (Guest)</button>
              </div>
          );
        }

        function App() {
            const [user, setUser] = useState(null);
            const [input, setInput] = useState('');
            const [messages, setMessages] = useState([]);
            const [loading, setLoading] = useState(true);
            const [isSidebarOpen, setSidebarOpen] = useState(false);
            const messagesEndRef = useRef(null);

            useEffect(() => {
                const unsub = onAuthStateChanged(auth, (u) => {
                    setUser(u);
                    setLoading(false);
                });
                return () => unsub();
            }, []);

            useEffect(() => {
                messagesEndRef.current?.scrollIntoView({ behavior: "smooth" });
            }, [messages]);

            const handleSend = async () => {
                if (!input.trim()) return;
                const userMsg = { role: 'user', content: input };
                setMessages(prev => [...prev, userMsg]);
                setInput('');
                setMessages(prev => [...prev, { role: 'ai', content: 'Thinking...', isLoading: true }]);

                try {
                    const response = await callBackendAI({
                        contents: [{ parts: [{ text: input }] }],
                        model: 'gemini-1.5-flash'
                    });
                    
                    let aiText = "Sorry, error occurred.";
                    if (response && response.candidates && response.candidates[0].content) {
                        aiText = response.candidates[0].content.parts[0].text;
                    }

                    setMessages(prev => {
                        const newMsgs = prev.filter(m => !m.isLoading);
                        return [...newMsgs, { role: 'ai', content: aiText }];
                    });
                } catch (e) {
                    setMessages(prev => {
                        const newMsgs = prev.filter(m => !m.isLoading);
                        return [...newMsgs, { role: 'ai', content: "Connection Error. Please check your internet." }];
                    });
                }
            };

            if (loading) return <div className="h-screen flex items-center justify-center bg-white">Loading...</div>;
            if (!user) return <LoginScreen onLogin={() => signInWithPopup(auth, googleProvider)} onAnonLogin={() => signInAnonymously(auth)} />;

            return (
                <div className="flex h-screen bg-white overflow-hidden">
                    {/* Sidebar */}
                    <div className={`fixed inset-y-0 left-0 z-50 w-64 bg-slate-900 text-white transform transition-transform duration-300 ${isSidebarOpen ? 'translate-x-0' : '-translate-x-full'} md:translate-x-0 md:relative`}>
                        <div className="p-4 flex justify-between items-center border-b border-gray-800">
                            <span className="font-bold flex items-center gap-2"><PadhaiSetuLogo/> PadhaiSetu</span>
                            <button onClick={() => setSidebarOpen(false)} className="md:hidden"><X size={20}/></button>
                        </div>
                        <div className="p-4">
                            <button onClick={() => setMessages([])} className="w-full bg-cyan-600 p-2 rounded-lg flex items-center justify-center gap-2 font-medium mb-4"><Plus size={16}/> New Chat</button>
                            <div className="text-xs text-gray-500 uppercase tracking-widest mb-2">User</div>
                            <div className="flex items-center gap-2 text-gray-300 text-sm">
                                <div className="w-8 h-8 rounded-full bg-purple-500 flex items-center justify-center">{user.displayName ? user.displayName[0] : 'G'}</div>
                                <div className="truncate">{user.displayName || 'Guest'}</div>
                            </div>
                        </div>
                    </div>

                    {/* Main Chat */}
                    <div className="flex-1 flex flex-col h-full relative">
                        <header className="h-16 border-b flex items-center justify-between px-4 bg-white">
                            <button onClick={() => setSidebarOpen(true)} className="md:hidden"><Menu className="text-gray-600"/></button>
                            <h2 className="font-bold text-gray-800">PadhaiSetu</h2>
                            <button onClick={() => signOut(auth)} className="text-red-500"><LogOut size={20}/></button>
                        </header>

                        <div className="flex-1 overflow-y-auto p-4 space-y-4 pb-20 bg-gray-50">
                            {messages.length === 0 && (
                                <div className="flex flex-col items-center justify-center h-full text-center text-gray-500">
                                    <Sparkles className="w-12 h-12 text-cyan-400 mb-4"/>
                                    <p>Ask me anything about your studies!</p>
                                </div>
                            )}
                            {messages.map((m, i) => (
                                <div key={i} className={`flex ${m.role === 'user' ? 'justify-end' : 'justify-start'}`}>
                                    <div className={`max-w-[85%] p-3 rounded-2xl ${m.role === 'user' ? 'bg-cyan-600 text-white rounded-tr-none' : 'bg-white text-gray-800 border border-gray-200 shadow-sm rounded-tl-none'}`}>
                                        <p className="whitespace-pre-wrap text-sm leading-relaxed">{m.content}</p>
                                    </div>
                                </div>
                            ))}
                            <div ref={messagesEndRef}></div>
                        </div>

                        <div className="p-3 bg-white border-t sticky bottom-0">
                            <div className="flex items-center gap-2 bg-gray-100 p-2 rounded-full border border-gray-200">
                                <input 
                                    className="flex-1 bg-transparent border-none outline-none px-2 text-sm"
                                    placeholder="Type your question..."
                                    value={input}
                                    onChange={(e) => setInput(e.target.value)}
                                    onKeyDown={(e) => e.key === 'Enter' && handleSend()}
                                />
                                <button onClick={handleSend} className="p-2 bg-black text-white rounded-full hover:bg-gray-800 transition">
                                    <Send size={18}/>
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            );
        }

        const root = createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
    </html>
    
